<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تسجيل الحضور</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <style>
    body { direction: rtl; text-align: center; font-family: Arial,sans-serif; padding: 20px; }
    .hidden { display: none; }
    .form-fields { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-top: 20px; }
    button { margin: 10px; padding: 10px 20px; font-size: 1rem; cursor: pointer; }
  </style>
</head>
<body>
  <div id="qr-placeholder"></div>

  <div class="form-fields">
    <select id="username" required>
      <option value="">-- اختر الاسم --</option>
      <option value="أحمد محمد">أحمد محمد</option>
      <option value="سارة عبدالله">سارة عبدالله</option>
      <option value="يوسف خالد">يوسف خالد</option>
    </select>
    <input type="tel" id="phone" placeholder="9715XXXXXXXX" required />
    <small>مثال: 971501234567</small>
  </div>

  <div id="buttons-container" class="hidden">
    <button id="check-in">تسجيل الحضور</button>
    <button id="check-out">تسجيل الانصراف</button>
  </div>

  <div id="g_id_signin"></div>

  <script>
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token') || '';
  let userFingerprint = null, userEmail = null;

  new QRCode(document.getElementById("qr-placeholder"), {
    text: `${window.location.origin}${window.location.pathname}?token=${token}`,
    width:256, height:256
  });

  import('https://openfpcdn.io/fingerprintjs/v4')
    .then(FingerprintJS => FingerprintJS.load())
    .then(fp => fp.get())
    .then(res => { userFingerprint = res.visitorId; initGoogleSignIn(); });

  function initGoogleSignIn(){
    google.accounts.id.initialize({
      client_id: '250943951703-sbgdp0c7f7mvvp2q5o705dolc8j4i9tf.apps.googleusercontent.com',
      callback: handleCredentialResponse, ux_mode:'popup'
    });
    google.accounts.id.renderButton(document.getElementById('g_id_signin'),
    { theme:'outline', size:'large', locale:'ar' });
  }

  function handleCredentialResponse(resp){
    fetch('https://oauth2.googleapis.com/tokeninfo?id_token='+resp.credential)
      .then(r => r.json())
      .then(data => {
        userEmail = data.email;
        document.getElementById('g_id_signin').classList.add('hidden');
        document.getElementById('buttons-container').classList.remove('hidden');
      });
  }

  const phoneInput = document.getElementById("phone");
  phoneInput.addEventListener("focus", ()=>{ if(!phoneInput.value.startsWith("9715")) phoneInput.value="9715"; });
  phoneInput.addEventListener("keydown", e=> {
    const prefix="9715";
    if(phoneInput.selectionStart<prefix.length && (e.key==="Backspace"||e.key==="Delete")) e.preventDefault();
  });
  function isValidPhone(p){ return /^9715\d{8}$/.test(p); }

  ['check-in','check-out'].forEach(id=>{
    document.getElementById(id).addEventListener('click', ()=>{
      const name = document.getElementById("username").value.trim();
      const phone = document.getElementById("phone").value.trim();
      if(!name||!phone){ return alert("❗ املئي الاسم والجوال"); }
      if(!isValidPhone(phone)){ return alert("❗ موبيل بصيغة 9715XXXXXXXX"); }
      const payload = { operation: id==='check-in'?'check-in':'check-out', token, fingerprint:userFingerprint, email:userEmail, name, phone, ip:null };
      fetch('https://script.google.com/macros/s/AKfycbzVkJOdbGyQQ9trP3YiCN3bXkBEop7sc9y1OSWs13LtvytuRO7apVlyEuSsAePKGHeIYA/exec', {
         method:'POST', headers:{ 'Content-Type':'application/json' }, body:JSON.stringify(payload)
      })
      .then(r=>r.json()).then(dt=>{
        alert(dt.success?"✅ تم التسجيل بنجاح":"❌ فشل التسجيل");
      }).catch(err=>{ console.error(err); alert("❌ خطأ أثناء الإرسال"); });
    });
  });
  </script>
</body>
</html>
  </script>
